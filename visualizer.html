<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Logger Visualizer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #232323; color: #a0a0a0; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 11px; line-height: 1.4; display: flex; height: 100vh; overflow: hidden; }

/* Sidebar */
.sidebar { width: 200px; background: #1e1e1e; border-right: 1px solid #2a2a2a; display: flex; flex-direction: column; flex-shrink: 0; }
.sidebar-header { padding: 8px; border-bottom: 1px solid #2a2a2a; }
.sidebar-header h1 { font-size: 10px; font-weight: 600; color: #707070; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
.btn { background: linear-gradient(to bottom, #3e3e3e, #333); border: 1px solid #282828; color: #909090; padding: 4px 8px; font-size: 10px; cursor: pointer; text-transform: uppercase; letter-spacing: 0.3px; }
.btn:active { background: linear-gradient(to bottom, #333, #3e3e3e); }
.btn:hover { color: #b0b0b0; }
.split-btn { position: relative; display: flex; }
.split-btn .btn-main { border-radius: 0; border-right: none; padding: 4px 10px; }
.split-btn .btn-drop { border-radius: 0; padding: 4px 5px; font-size: 8px; border-left: 1px solid #282828; }
.dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #333; border: 1px solid #282828; margin-top: 1px; z-index: 100; }
.dropdown.show { display: block; }
.dropdown-item { padding: 5px 8px; font-size: 10px; cursor: pointer; color: #909090; }
.dropdown-item:hover { background: #3a3a3a; color: #b0b0b0; }
.file-input { display: none; }

.stats-panel { padding: 8px; border-bottom: 1px solid #2a2a2a; }
.stat-row { display: flex; justify-content: space-between; padding: 2px 0; }
.stat-label { color: #555; }
.stat-value { color: #888; font-family: 'Consolas', monospace; }
.stat-value.highlight { color: #8a9a8a; }

.session-list { flex: 1; overflow-y: auto; }
.session-list::-webkit-scrollbar { width: 4px; }
.session-list::-webkit-scrollbar-track { background: #1e1e1e; }
.session-list::-webkit-scrollbar-thumb { background: #3a3a3a; }

.session-item { padding: 6px 8px; border-bottom: 1px solid #252525; cursor: pointer; }
.session-item:hover { background: #282828; }
.session-item.active { background: #2a2a2a; border-left: 2px solid #5a6a5a; }
.session-item.all-view { border-bottom: 1px solid #333; background: #222; }
.session-item.all-view:hover { background: #292929; }
.session-item.all-view.active { background: #2a2a2a; }
.session-title { font-size: 10px; color: #888; font-weight: 500; }
.session-meta { font-size: 9px; color: #555; margin-top: 2px; display: flex; gap: 8px; }
.session-server { color: #666; font-size: 9px; margin-top: 1px; }

/* Main */
.main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.toolbar { display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-bottom: 1px solid #2a2a2a; background: #262626; }
.toolbar-section { display: flex; align-items: center; gap: 6px; }
.toolbar-divider { width: 1px; height: 16px; background: #333; margin: 0 4px; }
.search-box { background: #1e1e1e; border: 1px solid #333; color: #a0a0a0; padding: 3px 6px; font-size: 10px; width: 160px; }
.search-box:focus { outline: none; border-color: #444; }
.search-box::placeholder { color: #505050; }
.filter-btn { background: linear-gradient(to bottom, #3a3a3a, #303030); border: 1px solid #282828; color: #707070; padding: 3px 8px; font-size: 9px; cursor: pointer; text-transform: uppercase; }
.filter-btn:active { background: linear-gradient(to bottom, #303030, #3a3a3a); }
.filter-btn:hover { color: #909090; }
.filter-btn.active { color: #8a9a8a; border-color: #4a5a4a; }
.info-text { color: #505050; font-size: 9px; margin-left: auto; }

.chat-container { flex: 1; overflow-y: auto; padding: 4px 0; }
.chat-container::-webkit-scrollbar { width: 6px; }
.chat-container::-webkit-scrollbar-track { background: #232323; }
.chat-container::-webkit-scrollbar-thumb { background: #3a3a3a; }

/* Messages */
.msg { display: grid; grid-template-columns: 70px 100px 1fr; gap: 8px; padding: 2px 10px; }
.msg:hover { background: #2a2a2a; }
.msg.whisper { font-style: italic; }
.msg.whisper .content { color: #6a6a8a; }
.msg.filtered { display: none; }
.msg.search-match { background: #2a2d2a; }
.time { color: #454545; font-family: 'Consolas', monospace; font-size: 10px; }
.player { color: #757575; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.content { color: #909090; word-break: break-word; }
.whisper-tag { color: #5a5a7a; font-size: 9px; margin-right: 3px; }

/* Session boundary */
.session-boundary { display: flex; align-items: center; gap: 10px; padding: 8px 10px; margin: 4px 0; }
.session-boundary-line { flex: 1; height: 1px; background: linear-gradient(to right, transparent, #3a3a3a, transparent); }
.session-boundary-text { color: #505050; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }

/* Player colors */
.p0 { color: #7a9a8a !important; } .p1 { color: #9a8a7a !important; } .p2 { color: #8a7a9a !important; }
.p3 { color: #9a7a8a !important; } .p4 { color: #7a8a9a !important; } .p5 { color: #8a9a7a !important; }
.p6 { color: #9a9a7a !important; } .p7 { color: #7a9a9a !important; } .p8 { color: #9a7a7a !important; }

/* Empty state */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #404040; }
.empty-state-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.3; }
.empty-state-text { font-size: 11px; }
.empty-state-hint { font-size: 9px; color: #353535; margin-top: 4px; }

/* Player list panel */
.players-panel { padding: 8px; border-top: 1px solid #2a2a2a; max-height: 120px; overflow-y: auto; }
.players-panel::-webkit-scrollbar { width: 3px; }
.players-panel::-webkit-scrollbar-thumb { background: #3a3a3a; }
.players-title { font-size: 9px; color: #505050; text-transform: uppercase; margin-bottom: 4px; }
.player-tag { display: inline-block; padding: 1px 5px; margin: 1px; font-size: 9px; background: #2a2a2a; border-radius: 2px; cursor: pointer; }
.player-tag:hover { background: #333; }
.player-tag.active { background: #3a4a3a; }
</style>
</head>
<body>
<div class="sidebar">
  <div class="sidebar-header">
    <h1>MC Chat Viewer</h1>
    <input type="file" id="fileInput" class="file-input" accept=".json,.zip" multiple>
    <input type="file" id="folderInput" class="file-input" webkitdirectory>
    <div class="split-btn">
      <button class="btn btn-main" onclick="document.getElementById('fileInput').click()">Load</button><button class="btn btn-drop" onclick="toggleDropdown(event)">▾</button>
      <div class="dropdown" id="dropdown">
        <div class="dropdown-item" onclick="document.getElementById('folderInput').click(); closeDropdown();">Load Folder</div>
      </div>
    </div>
  </div>
  <div class="stats-panel" id="statsPanel" style="display:none;">
    <div class="stat-row"><span class="stat-label">Sessions</span><span class="stat-value" id="statSessions">0</span></div>
    <div class="stat-row"><span class="stat-label">Total Time</span><span class="stat-value highlight" id="statTime">0h 0m</span></div>
    <div class="stat-row"><span class="stat-label">Messages</span><span class="stat-value" id="statMsgs">0</span></div>
    <div class="stat-row"><span class="stat-label">Whispers</span><span class="stat-value" id="statWhispers">0</span></div>
    <div class="stat-row"><span class="stat-label">Players</span><span class="stat-value" id="statPlayers">0</span></div>
  </div>
  <div class="session-list" id="sessionList"></div>
  <div class="players-panel" id="playersPanel" style="display:none;">
    <div class="players-title">Players</div>
    <div id="playerTags"></div>
  </div>
</div>
<div class="main">
  <div class="toolbar" id="toolbar" style="display:none;">
    <div class="toolbar-section">
      <input type="text" class="search-box" id="searchBox" placeholder="Search messages...">
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-section">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
      <button class="filter-btn" data-filter="chat" onclick="setFilter('chat')">Chat</button>
      <button class="filter-btn" data-filter="whisper" onclick="setFilter('whisper')">Whispers</button>
    </div>
    <span class="info-text" id="infoText"></span>
  </div>
  <div class="chat-container" id="chatContainer">
    <div class="empty-state">
      <div class="empty-state-icon">◈</div>
      <div class="empty-state-text">No logs loaded</div>
      <div class="empty-state-hint">Drop files/folder or click Load</div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let sessions = [];
let allMessages = [];
let currentView = 'all';
let currentFilter = 'all';
let playerColorMap = new Map();
let colorIndex = 0;
let allPlayers = new Map();
let activePlayerFilters = new Set();

function toggleDropdown(e) {
  e.stopPropagation();
  document.getElementById('dropdown').classList.toggle('show');
}
function closeDropdown() {
  document.getElementById('dropdown').classList.remove('show');
}
document.addEventListener('click', closeDropdown);

function getPlayerColor(uuid) {
  if (!playerColorMap.has(uuid)) {
    playerColorMap.set(uuid, `p${colorIndex % 9}`);
    colorIndex++;
  }
  return playerColorMap.get(uuid);
}

function parseMessage(msg) {
  const text = msg.message;
  const isWhisperTo = text.startsWith('You whisper to ');
  const isWhisperFrom = text.includes(' whispers to you:');
  const isWhisper = isWhisperTo || isWhisperFrom;
  
  let displayName = msg.senderName;
  let content = text;
  
  if (isWhisperTo) {
    const match = text.match(/^You whisper to ([^:]+): (.+)$/);
    if (match) { content = match[2]; }
  } else if (isWhisperFrom) {
    const match = text.match(/^([^ ]+) whispers to you: (.+)$/);
    if (match) { displayName = match[1]; content = match[2]; }
  } else {
    const match = text.match(/^<([^>]+)> (.+)$/);
    if (match) { displayName = match[1]; content = match[2]; }
  }
  
  return { isWhisper, isWhisperTo, isWhisperFrom, displayName, content };
}

function formatDuration(ms) {
  const mins = Math.floor(ms / 60000);
  const hours = Math.floor(mins / 60);
  const m = mins % 60;
  return hours > 0 ? `${hours}h ${m}m` : `${m}m`;
}

function formatDateTime(ts) {
  const d = new Date(ts.replace(' ', 'T'));
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + ts.split(' ')[1].substring(0, 5);
}

function formatTime(ts) {
  return ts.split(' ')[1].substring(0, 5);
}

function formatDate(ts) {
  const d = new Date(ts.replace(' ', 'T'));
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function processFiles(files) {
  sessions = [];
  allMessages = [];
  playerColorMap.clear();
  allPlayers.clear();
  colorIndex = 0;
  activePlayerFilters.clear();
  
  const jsonContents = [];
  
  for (const file of Array.from(files)) {
    if (file.name.endsWith('.json')) {
      jsonContents.push(new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try { resolve(JSON.parse(e.target.result)); } catch { resolve(null); }
        };
        reader.readAsText(file);
      }));
    } else if (file.name.endsWith('.zip')) {
      const zip = await JSZip.loadAsync(file);
      for (const [filename, zipEntry] of Object.entries(zip.files)) {
        if (filename.endsWith('.json') && !zipEntry.dir) {
          jsonContents.push(zipEntry.async('string').then(text => {
            try { return JSON.parse(text); } catch { return null; }
          }));
        }
      }
    }
  }
  
  const results = await Promise.all(jsonContents);
  sessions = results.filter(d => d && d.messages && d.messages.length).sort((a, b) => 
    new Date(a.sessionStart) - new Date(b.sessionStart)
  );
  
  sessions.forEach((s, idx) => {
    s._index = idx;
    s._duration = new Date(s.lastUpdated) - new Date(s.sessionStart);
    s.messages.forEach(m => {
      m._sessionIndex = idx;
      const parsed = parseMessage(m);
      m._parsed = parsed;
      m._color = getPlayerColor(m.senderUuid);
      if (!allPlayers.has(m.senderUuid)) {
        allPlayers.set(m.senderUuid, { name: parsed.displayName, uuid: m.senderUuid, count: 0 });
      }
      allPlayers.get(m.senderUuid).count++;
    });
    allMessages.push(...s.messages);
  });
  
  allMessages.sort((a, b) => a.epochMillis - b.epochMillis);
  
  renderStats();
  renderSessionList();
  renderPlayers();
  setView('all');
  
  document.getElementById('statsPanel').style.display = 'block';
  document.getElementById('toolbar').style.display = 'flex';
  document.getElementById('playersPanel').style.display = 'block';
}

function renderStats() {
  const totalTime = sessions.reduce((sum, s) => sum + s._duration, 0);
  const totalMsgs = allMessages.length;
  const whispers = allMessages.filter(m => m._parsed.isWhisper).length;
  
  document.getElementById('statSessions').textContent = sessions.length;
  document.getElementById('statTime').textContent = formatDuration(totalTime);
  document.getElementById('statMsgs').textContent = totalMsgs.toLocaleString();
  document.getElementById('statWhispers').textContent = whispers.toLocaleString();
  document.getElementById('statPlayers').textContent = allPlayers.size;
}

function renderSessionList() {
  const list = document.getElementById('sessionList');
  list.innerHTML = '';
  
  // All sessions view
  const allItem = document.createElement('div');
  allItem.className = 'session-item all-view active';
  allItem.onclick = () => setView('all');
  allItem.innerHTML = `
    <div class="session-title">All Sessions</div>
    <div class="session-meta">
      <span>${allMessages.length} msgs</span>
      <span>${sessions.length} sessions</span>
    </div>
  `;
  list.appendChild(allItem);
  
  sessions.forEach((s, idx) => {
    const item = document.createElement('div');
    item.className = 'session-item';
    item.onclick = () => setView(idx);
    item.innerHTML = `
      <div class="session-title">${formatDate(s.sessionStart)}</div>
      <div class="session-server">${s.server || 'Unknown server'}</div>
      <div class="session-meta">
        <span>${s.messageCount || s.messages.length} msgs</span>
        <span>${formatDuration(s._duration)}</span>
      </div>
    `;
    list.appendChild(item);
  });
}

function renderPlayers() {
  const container = document.getElementById('playerTags');
  container.innerHTML = '';
  
  const sorted = Array.from(allPlayers.values()).sort((a, b) => b.count - a.count);
  sorted.forEach(p => {
    const tag = document.createElement('span');
    tag.className = `player-tag ${getPlayerColor(p.uuid)}`;
    tag.textContent = `${p.name} (${p.count})`;
    tag.onclick = () => togglePlayerFilter(p.uuid);
    tag.dataset.uuid = p.uuid;
    container.appendChild(tag);
  });
}

function togglePlayerFilter(uuid) {
  if (activePlayerFilters.has(uuid)) {
    activePlayerFilters.delete(uuid);
  } else {
    activePlayerFilters.add(uuid);
  }
  document.querySelectorAll('.player-tag').forEach(t => {
    t.classList.toggle('active', activePlayerFilters.has(t.dataset.uuid));
  });
  applyFilters();
}

function setView(view) {
  currentView = view;
  
  document.querySelectorAll('.session-item').forEach((el, idx) => {
    if (idx === 0) {
      el.classList.toggle('active', view === 'all');
    } else {
      el.classList.toggle('active', view === idx - 1);
    }
  });
  
  renderChat();
}

function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });
  applyFilters();
}

function renderChat() {
  const container = document.getElementById('chatContainer');
  container.innerHTML = '';
  
  if (currentView === 'all') {
    let lastSessionIdx = -1;
    allMessages.forEach(msg => {
      if (msg._sessionIndex !== lastSessionIdx) {
        if (lastSessionIdx !== -1) {
          const boundary = document.createElement('div');
          boundary.className = 'session-boundary';
          const s = sessions[msg._sessionIndex];
          boundary.innerHTML = `
            <div class="session-boundary-line"></div>
            <span class="session-boundary-text">${formatDate(s.sessionStart)} · ${s.server || 'Unknown'}</span>
            <div class="session-boundary-line"></div>
          `;
          container.appendChild(boundary);
        }
        lastSessionIdx = msg._sessionIndex;
      }
      container.appendChild(createMessageEl(msg));
    });
    updateInfo(`${allMessages.length} messages across ${sessions.length} sessions`);
  } else {
    const session = sessions[currentView];
    session.messages.forEach(msg => {
      container.appendChild(createMessageEl(msg));
    });
    updateInfo(`${session.messages.length} messages · ${formatDuration(session._duration)}`);
  }
  
  applyFilters();
}

function createMessageEl(msg) {
  const parsed = msg._parsed;
  const row = document.createElement('div');
  row.className = `msg${parsed.isWhisper ? ' whisper' : ''}`;
  row.dataset.uuid = msg.senderUuid;
  row.dataset.type = parsed.isWhisper ? 'whisper' : 'chat';
  
  let whisperIndicator = '';
  if (parsed.isWhisperTo) whisperIndicator = '<span class="whisper-tag">→</span>';
  if (parsed.isWhisperFrom) whisperIndicator = '<span class="whisper-tag">←</span>';
  
  row.innerHTML = `
    <span class="time">${formatTime(msg.timestamp)}</span>
    <span class="player ${msg._color}">${whisperIndicator}${escapeHtml(parsed.displayName)}</span>
    <span class="content">${escapeHtml(parsed.content)}</span>
  `;
  return row;
}

function applyFilters() {
  const searchTerm = document.getElementById('searchBox').value.toLowerCase();
  const msgs = document.querySelectorAll('.msg');
  let visible = 0;
  
  msgs.forEach(el => {
    const matchesFilter = currentFilter === 'all' || el.dataset.type === currentFilter;
    const matchesPlayer = activePlayerFilters.size === 0 || activePlayerFilters.has(el.dataset.uuid);
    const matchesSearch = !searchTerm || el.textContent.toLowerCase().includes(searchTerm);
    
    const show = matchesFilter && matchesPlayer && matchesSearch;
    el.classList.toggle('filtered', !show);
    el.classList.toggle('search-match', show && searchTerm);
    if (show) visible++;
  });
  
  updateInfo(`${visible} messages shown`);
}

function updateInfo(text) {
  document.getElementById('infoText').textContent = text;
}

document.getElementById('searchBox').addEventListener('input', applyFilters);

document.getElementById('fileInput').addEventListener('change', (e) => {
  if (e.target.files.length) processFiles(e.target.files);
});

document.getElementById('folderInput').addEventListener('change', (e) => {
  if (e.target.files.length) processFiles(e.target.files);
});

document.body.addEventListener('dragover', (e) => e.preventDefault());
document.body.addEventListener('drop', (e) => {
  e.preventDefault();
  const items = e.dataTransfer.items;
  const files = [];
  
  const processEntry = (entry) => {
    return new Promise((resolve) => {
      if (entry.isFile) {
        entry.file(f => { files.push(f); resolve(); });
      } else if (entry.isDirectory) {
        const reader = entry.createReader();
        reader.readEntries(async (entries) => {
          await Promise.all(entries.map(e => processEntry(e)));
          resolve();
        });
      } else { resolve(); }
    });
  };
  
  const entries = Array.from(items).map(i => i.webkitGetAsEntry()).filter(Boolean);
  Promise.all(entries.map(e => processEntry(e))).then(() => {
    if (files.length) processFiles(files);
  });
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'f' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    document.getElementById('searchBox').focus();
  }
  if (e.key === 'Escape') {
    document.getElementById('searchBox').value = '';
    document.getElementById('searchBox').blur();
    applyFilters();
  }
});
</script>
</body>
</html>
